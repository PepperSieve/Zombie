from "../../third_party/ZoKrates/zokrates_stdlib/stdlib/hashes/poseidon/poseidon.zok" import generate_poseidon
from "EMBED" import u64_to_bits

// is u64 big endian or little endian in ZoKrates?
def computeMerkleRoot<HEIGHT>(field leaf, u64 directionSelector, field[HEIGHT] digests) -> field:
    field currentDigest = leaf
    // should be little endian, so need to be reversed
    bool[64] directionBits = u64_to_bits(directionSelector)
    field[2] inputToNextHash = [0; 2]
    field[HEIGHT] result = [0; HEIGHT]
     
    for u32 i in 0..HEIGHT do 
      for u32 j in 0..2 do
        inputToNextHash[j] = if directionBits[64 - i - 1] then if j >= 1 then currentDigest else digests[i] fi else if j < 1 then currentDigest else digests[i] fi fi
      endfor
      currentDigest = generate_poseidon(inputToNextHash)
    endfor
    return currentDigest

// test case
// leaf = moc.nozalleb.
def main(u32 x) -> bool:
  field[21] digests = [5810949145975268983677078150180109141833000559744284858058387945943982818158, 5725556692859964327615384670197743052032183597439067324056707782326754149039, 737987365019311986891486759646137884024555062575870812152535107633274882125, 6978415864521499843092624111016722859262479622172662553536833301034271706262, 4135208064219040665956576816380326101812041259000783076266688443246751604503, 3170260842944628279187126241517526053484378541795476268362403230613442052402, 4342359007634045612907285413193091075155071579174992137913324882848900239346, 865863211191910612990543945914043484144675745694815540239437037901450625109, 5338245711792133777698393453750146971681819747170395242636501304932379809960, 3971599647525318441413019352449721743960136015973593568651374667343390396180, 6781766165911636738711413118313274719395557174639193685513603627811259323393, 6567640779716870031735217184183741356489258821829157665850681332082834576535, 6191305287335176564696816642287358623642659237049314275921775543604346368066, 6966400339991045274968589508279503115523111941692065146897205830618452544258, 1932855327274373118649578109656632980426924425832054484211124717453633370522, 2422517079429369491095512851537216478826546687856281300427936709663355540147, 1828355802689263445921624588217734691264544626928882494763041934854213400746, 5425169782538910714092423632218831094890099464960756551344981699594055460447, 2326252787767864222978752870209848689412849751880836738068297509804573644232, 2926199112255787778707184107940826811888856500774718781576137388347946365290, 5862428253581911978164236873998992598944144594277149928428395602902613123842]
  u64 directionSelector = 852258
  field leaf = 4839109933088249563345538684967196188604080928683251255855801088884596272688
  field result = computeMerkleRoot(leaf, directionSelector, digests)
  return result == 5972733345965465510373436926431083918242531555386867859948086370295902707692